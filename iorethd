#!/usr/bin/env python3
import sys, logging, time, signal
from ioreth.bot import ReplyBot

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)-15s %(levelname)s: %(funcName)s %(message)s"
)
logger = logging.getLogger(__name__)

should_run = True

def shutdown(signum, frame):
    global should_run
    logger.info("Shutdown signal received, stopping bot loop.")
    should_run = False

signal.signal(signal.SIGINT, shutdown)
signal.signal(signal.SIGTERM, shutdown)

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <config-file.conf>")
        sys.exit(1)

    try:
        b = ReplyBot(sys.argv[1])
    except Exception as e:
        logger.exception("Failed to initialize ReplyBot")
        sys.exit(1)

    logger.info("Bot initialized, entering main loop")

    while should_run:
        try:
            b.on_loop_hook()
            time.sleep(1)  # Adjust loop frequency as needed
        except Exception:
            logger.exception("Fatal error in bot loop")
            time.sleep(3)

    logger.info("Bot shutdown complete.")
