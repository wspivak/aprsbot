#!/usr/bin/env python3
import sys, logging, time, signal
from ioreth.bot import ReplyBot

logging.basicConfig(level=logging.INFO,
    format="%(asctime)-15s %(levelname)s: %(funcName)s %(message)s")
logger = logging.getLogger(__name__)

def shutdown(signum, frame):
    logger.info("shutdown signal received, exiting")
    sys.exit(0)

signal.signal(signal.SIGINT, shutdown)
signal.signal(signal.SIGTERM, shutdown)

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: %s <config-file.conf>" % sys.argv[0])
        sys.exit(1)

    b = ReplyBot(sys.argv[1])

    # connect to Direwolf (the TNC)
    for attempt in range(5):
        try:
            b.connect()
            break
        except ConnectionRefusedError:
            print(f"[Retry {attempt+1}] Direwolf not ready, retrying in 3sâ€¦")
            time.sleep(3)
    else:
        print("Failed to connect after multiple attempts, exiting.")
        sys.exit(1)

    # now start processing input/output
    try:
        b.loop()
    except Exception:
        logger.exception("Fatal error in bot.loop()")
        sys.exit(1)
